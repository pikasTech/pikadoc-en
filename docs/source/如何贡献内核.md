# How to contribute to the kernel

## 1 Development Conventions

|                                           | Rule                           | Note        |
| ----------------------------------------- | ------------------------------ | ----------- |
| C Language Standard                       | C99 without GNU extensions     |             |
| Macros for constant value                 | Allowed                        |             |
| Function-like macros                      | Avoid in principle             |             |
| Macro Switches                            | Use with cautions              |             |
| Macro Splicing                            | Avoid in principle             |             |
| Naming rules for variables                | words separated by underscores | Linux Style |
| Naming rules for functions                | words separated by underscores | Linux Style |
| Naming rules for properties (for classes) | Small-Camel                    |             |

**Note**: For items Avoid-in-principle, if it is really necessary to use them, each use needs to be discussed separately.

### 1.1 Exceptions
- [PLOOC](https://github.com/GorgonMeducer/PLOOC) - The Protected Low-overhead Object Oriented Programming
- [__instruction_def.h](https://github.com/pikasTech/pikascript/blob/master/src/__instruction_def.h) - Autoly manage the VM instructions.



## 2 Kernel development environment

### 2.1 Option 1 Development under Linux (recommended)
Linux environment recommended ubuntu20.04

installation steps:

step1: pull the project
```bash
git clone https://github.com/pikastech/pikascript cd pikascript/port/linux
````
step2: compile the project
```bash
sh install_dependency.sh # Install dependencies, run for the first time
sh pull-core.sh #pull the source code from the /src directory and run it for the first time
sh init.sh # run before the first compilation, no need to run after that
sh make.sh # compile the project
````
step3: run unit tests
```bash
sh gtest.sh
````
step4: run the benchmark
```bash
sh ci_benchmark.sh
````
step5: Submit source code
```bash
sh push-core.sh # Push source code to /src directory
git commit -a
git push
````
### 2.2 Scheme 2 pico real machine development
Prepare a copy of the Raspberry Pi pico development board, then clone the complete repository and use the bsp/pico-dev project in the repository.



## 3 Object-Oriented Programming with ANSI-C

### 3.1 Overview

PikaScript employs the popular **Object-Oriented Programming with ANSI-C**, a.ka. **OOPC** methodology in the design and uses an open-source OOPC template, i.e. [PLOOC](https://github.com/GorgonMeducer/PLOOC) in the kernel. In addition to the normal structure based class definition, PLOOC introduced a so-called masked-structures. With this trick, members of a class can not only be marked as **private**, **protected** and **public**, but also actually protected as private and protected as those native OO languages, such as C++, C# etc. 

For example, in the `dataMemory.h`, it defines a class `Pool`:

```c
#if defined(__DATA_MEMORY_CLASS_IMPLEMENT__)
#define __PLOOC_CLASS_IMPLEMENT__
#elif defined(__DATA_MEMORY_CLASS_INHERIT__)
#define __PLOOC_CLASS_INHERIT__
#endif

#include "__pika_ooc.h"

...

dcl_class(Pool);

def_class(Pool, 
    private_member(
        BitMap bitmap;
        uint8_t* mem;
        uint8_t aline;
        uint32_t size;
        uint32_t first_free_block;
        uint32_t purl_free_block_start;
    )
);
```

Here, all members are embraced with `private_member()`, that means outside the class scope, people cannot see/access those private members, as shown below:

![](./assets/image-20220522025138842.png) 

While, in the `dataMemory.h`, a macro `__DATA_MEMORY_CLASS_IMPLEMENT__` is added before any including:

```c
#define __DATA_MEMORY_CLASS_IMPLEMENT__
#include "dataMemory.h"
#include "PikaPlatform.h"
...
```

hence, inside those methods of class `Pool`, we can see/access all members listed as private:

![](./assets/image-20220522025628225.png) 

This is because macro `__DATA_MEMORY_CLASS_IMPLEMENT__` marks the whole `dataMemory.c` as it is inside the `Pool` class scope. 

### 3.2 Visibility Control

PLOOC is a tool to force a visibility control in our c programming. There are plenty of ways to remove those visibility control in different scales, as shown in the **Table 3-1**:

**Table 3-1 Summary of visibility controls in PLOOC**

| Token (Macro)                              | Scope  | Usage                                                       | Description                                                  |
| ------------------------------------------ | ------ | ----------------------------------------------------------- | ------------------------------------------------------------ |
| **\_\_OOC_DEBUG\_\_**                      | Global | Define it in the project configuration                      | Disable protection for private and protected members. We only use this feature for debugging purpose. |
| **\_\_OOC_CPP\_\_**                        | Global | Define it in the project configuration                      | When you including PLOOC enabled header files in any CPP source files, please define this macro to avoid compilation errors. |
| **\_\_\<class_name\>_CLASS_IMPLEMENT\_\_** | Local  | Define it at the very beginning of the target c source file | It marks current c source file as if it is inside the scope of the target class. You can access all class members. |
| **\_\_\<class_name\>_CLASS_INHERIT\_\_**   | Local  | Define it at the very beginning of the target c source file | It marks current c source file as if it is inside the scope of a derived class of the target class (base class). You can access the protected and public members of the base class. |

NOTE: Please use these Tokens carefully and following the OO design principles. 

### 3.3 Rules of using PLOOC inside PikaScript

- We only use PLOOC inside kernel in principle 
- Contributors are **NOT** forced to use PLOOC even contribute to kernel. 
  - Unless otherwise state, we assume that you agree that the maintainer are authorized to modify your code for adding PLOOC. 
